{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "f5e3e0d9-fff4-4fb8-8e0a-1818178f821c",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "import logging                                                    # module for displaying relevant information in the logs\n",
    "import sys                                                        # to access to some variables used or maintained by the interpreter \n",
    "import argparse                                                   # to parse arguments from passed in the hyperparameters\n",
    "import os                                                         # to manage environmental variables\n",
    "import json                                                       # to open the json file with labels\n",
    "from transformers import (                                        # required classes to perform the model training and implement early stopping\n",
    "    ASTFeatureExtractor, \n",
    "    ASTForAudioClassification, \n",
    "    Trainer, \n",
    "    TrainingArguments, \n",
    "    EarlyStoppingCallback\n",
    ")                                    \n",
    "import torch                                                       # library to work with PyTorch tensors and to figure out if we have a GPU available\n",
    "from datasets import load_dataset, Audio, Dataset                  # required tools to create, load and process our audio dataset\n",
    "import pandas as pd                                                # home of the DataFrame construct, _the_ most important object for Data Science\n",
    "from preprocessing import preprocess_audio_arrays                  # functions to preprocess the dataset with ASTFeatureExtractor\n",
    "from gdsc_eval import compute_metrics, make_predictions, make_chunked_predictions           # functions to create predictions and evaluate them\n",
    "from typing import Optional                                        # for type hints\n",
    "                                # Add the source directory to the PYTHONPATH. This allows to import local functions and modules.\n",
    "from config import DEFAULT_BUCKET, DEFAULT_REGION  "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "ab6d94f2-1d09-4ad7-97b4-1332e4d80a7c",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "# CONFIG\n",
    "\n",
    "SAMPLING_RATE = 22050\n",
    "\n",
    "SPLIT_IN_SECS = 10  # in seconds\n",
    "CHUNK_MIN_SIZE = 1  # in seconds\n",
    "\n",
    "model_name = 'sm-training-custom-2023-06-21-12-27-40-579'\n",
    "checkpoint = 'checkpoint-3504'\n",
    "\n",
    "FOLDER_TO_PROCESS = 'test'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "1b07dd91-6990-46fa-9ae8-72952a2635f8",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "model_path =f\"/root/data/experiments/models/{model_name}/{checkpoint}\"\n",
    "\n",
    "feature_extractor = ASTFeatureExtractor.from_pretrained(model_path)\n",
    "model = ASTForAudioClassification.from_pretrained(model_path)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "96e109ff-ec6b-47a4-92ed-796bdc4b1c23",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "d99813ca9b0c4e489669f63d8adcc1e1",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Resolving data files:   0%|          | 0/557 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Found cached dataset audiofolder (/root/.cache/huggingface/datasets/audiofolder/default-2d285a18baf538c5/0.0.0/6cbdd16f8688354c63b4e2a36e1585d05de285023ee6443ffd71c4182055c0fc)\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "03f9f08354de40ebb8a5c1b093de414e",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "  0%|          | 0/1 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dataset({\n",
      "    features: ['audio'],\n",
      "    num_rows: 556\n",
      "})\n",
      "{'audio': {'path': '/root/data/data/test/0.wav', 'array': array([-2.13162821e-13,  4.26325641e-14, -7.03437308e-13, ...,\n",
      "       -3.38351354e-02,  8.03619623e-02,  2.31235102e-02]), 'sampling_rate': 22050}}\n"
     ]
    }
   ],
   "source": [
    "test_path = f'/root/data/data/{FOLDER_TO_PROCESS}'\n",
    "test_dataset = load_dataset(\"audiofolder\", data_dir=test_path).get('train')\n",
    "test_dataset = test_dataset.cast_column(\"audio\", Audio(sampling_rate=SAMPLING_RATE))\n",
    "print(test_dataset)\n",
    "print(test_dataset[0])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "85e20b80-83c2-467f-af57-a2384afcb48e",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "['0.wav', '1.wav', '10.wav']\n",
      "Dataset({\n",
      "    features: ['audio', 'file_name'],\n",
      "    num_rows: 556\n",
      "})\n",
      "{'audio': {'path': '/root/data/data/test/0.wav', 'array': array([-2.13162821e-13,  4.26325641e-14, -7.03437308e-13, ...,\n",
      "       -3.38351354e-02,  8.03619623e-02,  2.31235102e-02]), 'sampling_rate': 22050}, 'file_name': '0.wav'}\n"
     ]
    }
   ],
   "source": [
    "remove_metadata = lambda x: x.endswith(\".wav\")\n",
    "extract_file_name = lambda x: x.split('/')[-1]\n",
    "\n",
    "test_paths = list(test_dataset.info.download_checksums.keys())\n",
    "\n",
    "test_paths = list(filter(remove_metadata, test_paths))\n",
    "test_paths = list(map(extract_file_name, test_paths))\n",
    "print(test_paths[:3])\n",
    "\n",
    "test_dataset = test_dataset.add_column(\"file_name\", test_paths)\n",
    "print(test_dataset)\n",
    "print(test_dataset[0])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "49244606-ce1d-4dd1-98d1-73b9d19dd001",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "0.wav - file_size:203392 - splitted into 1 chunks\n",
      "1.wav - file_size:73688 - splitted into 1 chunks\n",
      "10.wav - file_size:183152 - splitted into 1 chunks\n",
      "100.wav - file_size:245317 - splitted into 2 chunks\n",
      "101.wav - file_size:1587267 - splitted into 8 chunks\n",
      "102.wav - file_size:132300 - splitted into 1 chunks\n",
      "103.wav - file_size:88200 - splitted into 1 chunks\n",
      "104.wav - file_size:423334 - splitted into 2 chunks\n",
      "105.wav - file_size:132300 - splitted into 1 chunks\n",
      "106.wav - file_size:264600 - splitted into 2 chunks\n",
      "107.wav - file_size:110250 - splitted into 1 chunks\n",
      "108.wav - file_size:529200 - splitted into 3 chunks\n",
      "109.wav - file_size:154350 - splitted into 1 chunks\n",
      "11.wav - file_size:242550 - splitted into 2 chunks\n",
      "110.wav - file_size:132300 - splitted into 1 chunks\n",
      "111.wav - file_size:44100 - splitted into 1 chunks\n",
      "112.wav - file_size:1147730 - splitted into 6 chunks\n",
      "113.wav - file_size:3971672 - splitted into 18 chunks\n",
      "114.wav - file_size:220500 - splitted into 1 chunks\n",
      "115.wav - file_size:2094750 - splitted into 10 chunks\n",
      "116.wav - file_size:211530 - splitted into 1 chunks\n",
      "117.wav - file_size:110250 - splitted into 1 chunks\n",
      "118.wav - file_size:44100 - splitted into 1 chunks\n",
      "119.wav - file_size:507150 - splitted into 3 chunks\n",
      "12.wav - file_size:1296741 - splitted into 6 chunks\n",
      "120.wav - file_size:299557 - splitted into 2 chunks\n",
      "121.wav - file_size:147519 - splitted into 1 chunks\n",
      "122.wav - file_size:66150 - splitted into 1 chunks\n",
      "123.wav - file_size:44100 - splitted into 1 chunks\n",
      "124.wav - file_size:297472 - splitted into 2 chunks\n",
      "125.wav - file_size:220500 - splitted into 1 chunks\n",
      "126.wav - file_size:1580890 - splitted into 8 chunks\n",
      "127.wav - file_size:308700 - splitted into 2 chunks\n",
      "128.wav - file_size:66150 - splitted into 1 chunks\n",
      "129.wav - file_size:220500 - splitted into 1 chunks\n",
      "13.wav - file_size:1509575 - splitted into 7 chunks\n",
      "130.wav - file_size:132300 - splitted into 1 chunks\n",
      "131.wav - file_size:88200 - splitted into 1 chunks\n",
      "132.wav - file_size:308700 - splitted into 2 chunks\n",
      "133.wav - file_size:2629116 - splitted into 12 chunks\n",
      "134.wav - file_size:400158 - splitted into 2 chunks\n",
      "135.wav - file_size:66150 - splitted into 1 chunks\n",
      "136.wav - file_size:507150 - splitted into 3 chunks\n",
      "137.wav - file_size:352800 - splitted into 2 chunks\n",
      "138.wav - file_size:176400 - splitted into 1 chunks\n",
      "139.wav - file_size:242550 - splitted into 2 chunks\n",
      "14.wav - file_size:374850 - splitted into 2 chunks\n",
      "140.wav - file_size:463050 - splitted into 3 chunks\n",
      "141.wav - file_size:66150 - splitted into 1 chunks\n",
      "142.wav - file_size:2120930 - splitted into 10 chunks\n",
      "143.wav - file_size:352800 - splitted into 2 chunks\n",
      "144.wav - file_size:308700 - splitted into 2 chunks\n",
      "145.wav - file_size:66150 - splitted into 1 chunks\n",
      "146.wav - file_size:463050 - splitted into 3 chunks\n",
      "147.wav - file_size:1323000 - splitted into 6 chunks\n",
      "148.wav - file_size:661500 - splitted into 3 chunks\n",
      "149.wav - file_size:44100 - splitted into 1 chunks\n",
      "15.wav - file_size:176400 - splitted into 1 chunks\n",
      "150.wav - file_size:617400 - splitted into 3 chunks\n",
      "151.wav - file_size:771750 - splitted into 4 chunks\n",
      "152.wav - file_size:110250 - splitted into 1 chunks\n",
      "153.wav - file_size:66150 - splitted into 1 chunks\n",
      "154.wav - file_size:74970 - splitted into 1 chunks\n",
      "155.wav - file_size:242550 - splitted into 2 chunks\n",
      "156.wav - file_size:306396 - splitted into 2 chunks\n",
      "157.wav - file_size:459767 - splitted into 2 chunks\n",
      "158.wav - file_size:374850 - splitted into 2 chunks\n",
      "159.wav - file_size:1323000 - splitted into 6 chunks\n",
      "16.wav - file_size:330750 - splitted into 2 chunks\n",
      "160.wav - file_size:1307792 - splitted into 6 chunks\n",
      "161.wav - file_size:220500 - splitted into 1 chunks\n",
      "162.wav - file_size:44100 - splitted into 1 chunks\n",
      "163.wav - file_size:138915 - splitted into 1 chunks\n",
      "164.wav - file_size:279689 - splitted into 2 chunks\n",
      "165.wav - file_size:92610 - splitted into 1 chunks\n",
      "166.wav - file_size:401461 - splitted into 2 chunks\n",
      "167.wav - file_size:967640 - splitted into 5 chunks\n",
      "168.wav - file_size:487305 - splitted into 3 chunks\n",
      "169.wav - file_size:138916 - splitted into 1 chunks\n",
      "17.wav - file_size:154350 - splitted into 1 chunks\n",
      "170.wav - file_size:66150 - splitted into 1 chunks\n",
      "171.wav - file_size:85995 - splitted into 1 chunks\n",
      "172.wav - file_size:220500 - splitted into 1 chunks\n",
      "173.wav - file_size:229320 - splitted into 1 chunks\n",
      "174.wav - file_size:551250 - splitted into 3 chunks\n",
      "175.wav - file_size:1381381 - splitted into 7 chunks\n",
      "176.wav - file_size:217457 - splitted into 1 chunks\n",
      "177.wav - file_size:1014300 - splitted into 5 chunks\n",
      "178.wav - file_size:978828 - splitted into 5 chunks\n",
      "179.wav - file_size:154350 - splitted into 1 chunks\n",
      "18.wav - file_size:2359350 - splitted into 11 chunks\n",
      "180.wav - file_size:321830 - splitted into 2 chunks\n",
      "181.wav - file_size:110250 - splitted into 1 chunks\n",
      "182.wav - file_size:1300950 - splitted into 6 chunks\n",
      "183.wav - file_size:374850 - splitted into 2 chunks\n",
      "184.wav - file_size:22050 - splitted into 1 chunks\n",
      "185.wav - file_size:485100 - splitted into 3 chunks\n",
      "186.wav - file_size:374850 - splitted into 2 chunks\n",
      "187.wav - file_size:55125 - splitted into 1 chunks\n",
      "188.wav - file_size:83790 - splitted into 1 chunks\n",
      "189.wav - file_size:221760 - splitted into 1 chunks\n",
      "19.wav - file_size:1778337 - splitted into 8 chunks\n",
      "190.wav - file_size:66150 - splitted into 1 chunks\n",
      "191.wav - file_size:374850 - splitted into 2 chunks\n",
      "192.wav - file_size:88200 - splitted into 1 chunks\n",
      "193.wav - file_size:727520 - splitted into 4 chunks\n",
      "194.wav - file_size:331520 - splitted into 2 chunks\n",
      "195.wav - file_size:617400 - splitted into 3 chunks\n",
      "196.wav - file_size:793800 - splitted into 4 chunks\n",
      "197.wav - file_size:414400 - splitted into 2 chunks\n",
      "198.wav - file_size:441000 - splitted into 2 chunks\n",
      "199.wav - file_size:483765 - splitted into 3 chunks\n",
      "2.wav - file_size:970200 - splitted into 5 chunks\n",
      "20.wav - file_size:308700 - splitted into 2 chunks\n",
      "200.wav - file_size:286650 - splitted into 2 chunks\n",
      "201.wav - file_size:154350 - splitted into 1 chunks\n",
      "202.wav - file_size:220500 - splitted into 1 chunks\n",
      "203.wav - file_size:352800 - splitted into 2 chunks\n",
      "204.wav - file_size:154350 - splitted into 1 chunks\n",
      "205.wav - file_size:283136 - splitted into 2 chunks\n",
      "206.wav - file_size:304290 - splitted into 2 chunks\n",
      "207.wav - file_size:242550 - splitted into 2 chunks\n",
      "208.wav - file_size:176400 - splitted into 1 chunks\n",
      "209.wav - file_size:617400 - splitted into 3 chunks\n",
      "21.wav - file_size:467460 - splitted into 3 chunks\n",
      "210.wav - file_size:97993 - splitted into 1 chunks\n",
      "211.wav - file_size:512478 - splitted into 3 chunks\n",
      "212.wav - file_size:176400 - splitted into 1 chunks\n",
      "213.wav - file_size:1223690 - splitted into 6 chunks\n",
      "214.wav - file_size:1543500 - splitted into 7 chunks\n",
      "215.wav - file_size:617400 - splitted into 3 chunks\n",
      "216.wav - file_size:2123132 - splitted into 10 chunks\n",
      "217.wav - file_size:220500 - splitted into 1 chunks\n",
      "218.wav - file_size:44100 - splitted into 1 chunks\n",
      "219.wav - file_size:605637 - splitted into 3 chunks\n",
      "22.wav - file_size:399312 - splitted into 2 chunks\n",
      "220.wav - file_size:289455 - splitted into 2 chunks\n",
      "221.wav - file_size:154350 - splitted into 1 chunks\n",
      "222.wav - file_size:558048 - splitted into 3 chunks\n",
      "223.wav - file_size:595350 - splitted into 3 chunks\n",
      "224.wav - file_size:220500 - splitted into 1 chunks\n",
      "225.wav - file_size:66150 - splitted into 1 chunks\n",
      "226.wav - file_size:242550 - splitted into 2 chunks\n",
      "227.wav - file_size:44100 - splitted into 1 chunks\n",
      "228.wav - file_size:837900 - splitted into 4 chunks\n",
      "229.wav - file_size:2028600 - splitted into 10 chunks\n",
      "23.wav - file_size:1932240 - splitted into 9 chunks\n",
      "230.wav - file_size:220500 - splitted into 1 chunks\n",
      "231.wav - file_size:88200 - splitted into 1 chunks\n",
      "232.wav - file_size:573300 - splitted into 3 chunks\n",
      "233.wav - file_size:992250 - splitted into 5 chunks\n",
      "234.wav - file_size:993407 - splitted into 5 chunks\n",
      "235.wav - file_size:348390 - splitted into 2 chunks\n",
      "236.wav - file_size:480000 - splitted into 3 chunks\n",
      "237.wav - file_size:1901487 - splitted into 9 chunks\n",
      "238.wav - file_size:44100 - splitted into 1 chunks\n",
      "239.wav - file_size:105728 - splitted into 1 chunks\n",
      "24.wav - file_size:253575 - splitted into 2 chunks\n",
      "240.wav - file_size:264600 - splitted into 2 chunks\n",
      "241.wav - file_size:418950 - splitted into 2 chunks\n",
      "242.wav - file_size:940896 - splitted into 5 chunks\n",
      "243.wav - file_size:264600 - splitted into 2 chunks\n",
      "244.wav - file_size:1653750 - splitted into 8 chunks\n",
      "245.wav - file_size:352800 - splitted into 2 chunks\n",
      "246.wav - file_size:253575 - splitted into 2 chunks\n",
      "247.wav - file_size:160965 - splitted into 1 chunks\n",
      "248.wav - file_size:87318 - splitted into 1 chunks\n",
      "249.wav - file_size:215040 - splitted into 1 chunks\n",
      "25.wav - file_size:811776 - splitted into 4 chunks\n",
      "250.wav - file_size:72765 - splitted into 1 chunks\n",
      "251.wav - file_size:166656 - splitted into 1 chunks\n",
      "252.wav - file_size:132300 - splitted into 1 chunks\n",
      "253.wav - file_size:44100 - splitted into 1 chunks\n",
      "254.wav - file_size:132300 - splitted into 1 chunks\n",
      "255.wav - file_size:66150 - splitted into 1 chunks\n",
      "256.wav - file_size:1185710 - splitted into 6 chunks\n",
      "257.wav - file_size:30871 - splitted into 1 chunks\n",
      "258.wav - file_size:1701753 - splitted into 8 chunks\n",
      "259.wav - file_size:62720 - splitted into 1 chunks\n",
      "26.wav - file_size:88200 - splitted into 1 chunks\n",
      "260.wav - file_size:432390 - splitted into 2 chunks\n",
      "261.wav - file_size:44100 - splitted into 1 chunks\n",
      "262.wav - file_size:352800 - splitted into 2 chunks\n",
      "263.wav - file_size:815850 - splitted into 4 chunks\n",
      "264.wav - file_size:390000 - splitted into 2 chunks\n",
      "265.wav - file_size:88200 - splitted into 1 chunks\n",
      "266.wav - file_size:4510671 - splitted into 21 chunks\n",
      "267.wav - file_size:101430 - splitted into 1 chunks\n",
      "268.wav - file_size:595350 - splitted into 3 chunks\n",
      "269.wav - file_size:66150 - splitted into 1 chunks\n",
      "27.wav - file_size:110250 - splitted into 1 chunks\n",
      "270.wav - file_size:308700 - splitted into 2 chunks\n",
      "271.wav - file_size:66150 - splitted into 1 chunks\n",
      "272.wav - file_size:198450 - splitted into 1 chunks\n",
      "273.wav - file_size:510976 - splitted into 3 chunks\n",
      "274.wav - file_size:1367100 - splitted into 7 chunks\n",
      "275.wav - file_size:1609650 - splitted into 8 chunks\n",
      "276.wav - file_size:125685 - splitted into 1 chunks\n",
      "277.wav - file_size:176400 - splitted into 1 chunks\n",
      "278.wav - file_size:88200 - splitted into 1 chunks\n",
      "279.wav - file_size:1786050 - splitted into 9 chunks\n",
      "28.wav - file_size:213248 - splitted into 1 chunks\n",
      "280.wav - file_size:1036350 - splitted into 5 chunks\n",
      "281.wav - file_size:286650 - splitted into 2 chunks\n",
      "282.wav - file_size:1637980 - splitted into 8 chunks\n",
      "283.wav - file_size:948150 - splitted into 5 chunks\n",
      "284.wav - file_size:396900 - splitted into 2 chunks\n",
      "285.wav - file_size:177408 - splitted into 1 chunks\n",
      "286.wav - file_size:88200 - splitted into 1 chunks\n",
      "287.wav - file_size:176400 - splitted into 1 chunks\n",
      "288.wav - file_size:66150 - splitted into 1 chunks\n",
      "289.wav - file_size:974420 - splitted into 5 chunks\n",
      "29.wav - file_size:88200 - splitted into 1 chunks\n",
      "290.wav - file_size:44100 - splitted into 1 chunks\n",
      "291.wav - file_size:297472 - splitted into 2 chunks\n",
      "292.wav - file_size:132300 - splitted into 1 chunks\n",
      "293.wav - file_size:132369 - splitted into 1 chunks\n",
      "294.wav - file_size:2205000 - splitted into 10 chunks\n",
      "295.wav - file_size:494010 - splitted into 3 chunks\n",
      "296.wav - file_size:771750 - splitted into 4 chunks\n",
      "297.wav - file_size:1102500 - splitted into 5 chunks\n",
      "298.wav - file_size:726320 - splitted into 4 chunks\n",
      "299.wav - file_size:70983 - splitted into 1 chunks\n",
      "3.wav - file_size:926100 - splitted into 5 chunks\n",
      "30.wav - file_size:529200 - splitted into 3 chunks\n",
      "300.wav - file_size:1268479 - splitted into 6 chunks\n",
      "301.wav - file_size:90405 - splitted into 1 chunks\n",
      "302.wav - file_size:263241 - splitted into 2 chunks\n",
      "303.wav - file_size:1102500 - splitted into 5 chunks\n",
      "304.wav - file_size:97020 - splitted into 1 chunks\n",
      "305.wav - file_size:573300 - splitted into 3 chunks\n",
      "306.wav - file_size:2487375 - splitted into 12 chunks\n",
      "307.wav - file_size:88200 - splitted into 1 chunks\n",
      "308.wav - file_size:264600 - splitted into 2 chunks\n",
      "309.wav - file_size:264600 - splitted into 2 chunks\n",
      "31.wav - file_size:66150 - splitted into 1 chunks\n",
      "310.wav - file_size:132300 - splitted into 1 chunks\n",
      "311.wav - file_size:1319450 - splitted into 6 chunks\n",
      "312.wav - file_size:242550 - splitted into 2 chunks\n",
      "313.wav - file_size:101430 - splitted into 1 chunks\n",
      "314.wav - file_size:143325 - splitted into 1 chunks\n",
      "315.wav - file_size:33075 - splitted into 1 chunks\n",
      "316.wav - file_size:68355 - splitted into 1 chunks\n",
      "317.wav - file_size:463050 - splitted into 3 chunks\n",
      "318.wav - file_size:374850 - splitted into 2 chunks\n",
      "319.wav - file_size:154350 - splitted into 1 chunks\n",
      "32.wav - file_size:88200 - splitted into 1 chunks\n",
      "320.wav - file_size:903800 - splitted into 4 chunks\n",
      "321.wav - file_size:926100 - splitted into 5 chunks\n",
      "322.wav - file_size:1764000 - splitted into 8 chunks\n",
      "323.wav - file_size:255780 - splitted into 2 chunks\n",
      "324.wav - file_size:1014300 - splitted into 5 chunks\n",
      "325.wav - file_size:132300 - splitted into 1 chunks\n",
      "326.wav - file_size:22050 - splitted into 1 chunks\n",
      "327.wav - file_size:286650 - splitted into 2 chunks\n",
      "328.wav - file_size:103068 - splitted into 1 chunks\n",
      "329.wav - file_size:661500 - splitted into 3 chunks\n",
      "33.wav - file_size:264600 - splitted into 2 chunks\n",
      "330.wav - file_size:44100 - splitted into 1 chunks\n",
      "331.wav - file_size:308700 - splitted into 2 chunks\n",
      "332.wav - file_size:220275 - splitted into 1 chunks\n",
      "333.wav - file_size:326736 - splitted into 2 chunks\n",
      "334.wav - file_size:88200 - splitted into 1 chunks\n",
      "335.wav - file_size:57344 - splitted into 1 chunks\n",
      "336.wav - file_size:3230098 - splitted into 15 chunks\n",
      "337.wav - file_size:176400 - splitted into 1 chunks\n",
      "338.wav - file_size:154350 - splitted into 1 chunks\n",
      "339.wav - file_size:352800 - splitted into 2 chunks\n",
      "34.wav - file_size:827282 - splitted into 4 chunks\n",
      "340.wav - file_size:110592 - splitted into 1 chunks\n",
      "341.wav - file_size:220500 - splitted into 1 chunks\n",
      "342.wav - file_size:1810550 - splitted into 9 chunks\n",
      "343.wav - file_size:3960672 - splitted into 18 chunks\n",
      "344.wav - file_size:510336 - splitted into 3 chunks\n",
      "345.wav - file_size:220500 - splitted into 1 chunks\n",
      "346.wav - file_size:308700 - splitted into 2 chunks\n",
      "347.wav - file_size:644330 - splitted into 3 chunks\n",
      "348.wav - file_size:110250 - splitted into 1 chunks\n",
      "349.wav - file_size:257985 - splitted into 2 chunks\n",
      "35.wav - file_size:2756250 - splitted into 13 chunks\n",
      "350.wav - file_size:264600 - splitted into 2 chunks\n",
      "351.wav - file_size:227115 - splitted into 1 chunks\n",
      "352.wav - file_size:329648 - splitted into 2 chunks\n",
      "353.wav - file_size:2425500 - splitted into 11 chunks\n",
      "354.wav - file_size:220500 - splitted into 1 chunks\n",
      "355.wav - file_size:7078684 - splitted into 33 chunks\n",
      "356.wav - file_size:970200 - splitted into 5 chunks\n",
      "357.wav - file_size:66150 - splitted into 1 chunks\n",
      "358.wav - file_size:66150 - splitted into 1 chunks\n",
      "359.wav - file_size:1684357 - splitted into 8 chunks\n",
      "36.wav - file_size:44100 - splitted into 1 chunks\n",
      "360.wav - file_size:573300 - splitted into 3 chunks\n",
      "361.wav - file_size:83790 - splitted into 1 chunks\n",
      "362.wav - file_size:99225 - splitted into 1 chunks\n",
      "363.wav - file_size:1081957 - splitted into 5 chunks\n",
      "364.wav - file_size:132300 - splitted into 1 chunks\n",
      "365.wav - file_size:705600 - splitted into 4 chunks\n",
      "366.wav - file_size:44100 - splitted into 1 chunks\n",
      "367.wav - file_size:81585 - splitted into 1 chunks\n",
      "368.wav - file_size:121275 - splitted into 1 chunks\n",
      "369.wav - file_size:374850 - splitted into 2 chunks\n",
      "37.wav - file_size:66150 - splitted into 1 chunks\n",
      "370.wav - file_size:308700 - splitted into 2 chunks\n",
      "371.wav - file_size:220500 - splitted into 1 chunks\n",
      "372.wav - file_size:350595 - splitted into 2 chunks\n",
      "373.wav - file_size:396900 - splitted into 2 chunks\n",
      "374.wav - file_size:264600 - splitted into 2 chunks\n",
      "375.wav - file_size:202693 - splitted into 1 chunks\n",
      "376.wav - file_size:136672 - splitted into 1 chunks\n",
      "377.wav - file_size:441000 - splitted into 2 chunks\n",
      "378.wav - file_size:66150 - splitted into 1 chunks\n",
      "379.wav - file_size:66150 - splitted into 1 chunks\n",
      "38.wav - file_size:110250 - splitted into 1 chunks\n",
      "380.wav - file_size:102652 - splitted into 1 chunks\n",
      "381.wav - file_size:286650 - splitted into 2 chunks\n",
      "382.wav - file_size:66150 - splitted into 1 chunks\n",
      "383.wav - file_size:1786050 - splitted into 9 chunks\n",
      "384.wav - file_size:235935 - splitted into 1 chunks\n",
      "385.wav - file_size:99225 - splitted into 1 chunks\n",
      "386.wav - file_size:384367 - splitted into 2 chunks\n",
      "387.wav - file_size:1323000 - splitted into 6 chunks\n",
      "388.wav - file_size:58430 - splitted into 1 chunks\n",
      "389.wav - file_size:374850 - splitted into 2 chunks\n",
      "39.wav - file_size:1389150 - splitted into 7 chunks\n",
      "390.wav - file_size:507150 - splitted into 3 chunks\n",
      "391.wav - file_size:396900 - splitted into 2 chunks\n",
      "392.wav - file_size:5007285 - splitted into 23 chunks\n",
      "393.wav - file_size:370944 - splitted into 2 chunks\n",
      "394.wav - file_size:396900 - splitted into 2 chunks\n",
      "395.wav - file_size:112455 - splitted into 1 chunks\n",
      "396.wav - file_size:242550 - splitted into 2 chunks\n",
      "397.wav - file_size:103635 - splitted into 1 chunks\n",
      "398.wav - file_size:176400 - splitted into 1 chunks\n",
      "399.wav - file_size:992250 - splitted into 5 chunks\n",
      "4.wav - file_size:159667 - splitted into 1 chunks\n",
      "40.wav - file_size:2714905 - splitted into 13 chunks\n",
      "400.wav - file_size:152117 - splitted into 1 chunks\n",
      "401.wav - file_size:22050 - splitted into 1 chunks\n",
      "402.wav - file_size:1058400 - splitted into 5 chunks\n",
      "403.wav - file_size:154350 - splitted into 1 chunks\n",
      "404.wav - file_size:308700 - splitted into 2 chunks\n",
      "405.wav - file_size:529200 - splitted into 3 chunks\n",
      "406.wav - file_size:134505 - splitted into 1 chunks\n",
      "407.wav - file_size:3613933 - splitted into 17 chunks\n",
      "408.wav - file_size:1743791 - splitted into 8 chunks\n",
      "409.wav - file_size:2094750 - splitted into 10 chunks\n",
      "41.wav - file_size:1586271 - splitted into 8 chunks\n",
      "410.wav - file_size:110250 - splitted into 1 chunks\n",
      "411.wav - file_size:92610 - splitted into 1 chunks\n",
      "412.wav - file_size:176400 - splitted into 1 chunks\n",
      "413.wav - file_size:176400 - splitted into 1 chunks\n",
      "414.wav - file_size:44100 - splitted into 1 chunks\n",
      "415.wav - file_size:110250 - splitted into 1 chunks\n",
      "416.wav - file_size:99225 - splitted into 1 chunks\n",
      "417.wav - file_size:308700 - splitted into 2 chunks\n",
      "418.wav - file_size:534320 - splitted into 3 chunks\n",
      "419.wav - file_size:749700 - splitted into 4 chunks\n",
      "42.wav - file_size:110250 - splitted into 1 chunks\n",
      "420.wav - file_size:2808630 - splitted into 13 chunks\n",
      "421.wav - file_size:330750 - splitted into 2 chunks\n",
      "422.wav - file_size:66150 - splitted into 1 chunks\n",
      "423.wav - file_size:408576 - splitted into 2 chunks\n",
      "424.wav - file_size:176400 - splitted into 1 chunks\n",
      "425.wav - file_size:518909 - splitted into 3 chunks\n",
      "426.wav - file_size:396900 - splitted into 2 chunks\n",
      "427.wav - file_size:198450 - splitted into 1 chunks\n",
      "428.wav - file_size:308700 - splitted into 2 chunks\n",
      "429.wav - file_size:164575 - splitted into 1 chunks\n",
      "43.wav - file_size:558667 - splitted into 3 chunks\n",
      "430.wav - file_size:66150 - splitted into 1 chunks\n",
      "431.wav - file_size:110250 - splitted into 1 chunks\n",
      "432.wav - file_size:352800 - splitted into 2 chunks\n",
      "433.wav - file_size:110250 - splitted into 1 chunks\n",
      "434.wav - file_size:204667 - splitted into 1 chunks\n",
      "435.wav - file_size:121856 - splitted into 1 chunks\n",
      "436.wav - file_size:507150 - splitted into 3 chunks\n",
      "437.wav - file_size:1234800 - splitted into 6 chunks\n",
      "438.wav - file_size:190432 - splitted into 1 chunks\n",
      "439.wav - file_size:170240 - splitted into 1 chunks\n",
      "44.wav - file_size:1190700 - splitted into 6 chunks\n",
      "440.wav - file_size:264600 - splitted into 2 chunks\n",
      "441.wav - file_size:441000 - splitted into 2 chunks\n",
      "442.wav - file_size:44100 - splitted into 1 chunks\n",
      "443.wav - file_size:551250 - splitted into 3 chunks\n",
      "444.wav - file_size:39690 - splitted into 1 chunks\n",
      "445.wav - file_size:463050 - splitted into 3 chunks\n",
      "446.wav - file_size:1036350 - splitted into 5 chunks\n",
      "447.wav - file_size:250290 - splitted into 2 chunks\n",
      "448.wav - file_size:220500 - splitted into 1 chunks\n",
      "449.wav - file_size:308700 - splitted into 2 chunks\n",
      "45.wav - file_size:330750 - splitted into 2 chunks\n",
      "450.wav - file_size:220500 - splitted into 1 chunks\n",
      "451.wav - file_size:220500 - splitted into 1 chunks\n",
      "452.wav - file_size:597410 - splitted into 3 chunks\n",
      "453.wav - file_size:352800 - splitted into 2 chunks\n",
      "454.wav - file_size:66150 - splitted into 1 chunks\n",
      "455.wav - file_size:1470395 - splitted into 7 chunks\n",
      "456.wav - file_size:176400 - splitted into 1 chunks\n",
      "457.wav - file_size:2431931 - splitted into 11 chunks\n",
      "458.wav - file_size:463050 - splitted into 3 chunks\n",
      "459.wav - file_size:66150 - splitted into 1 chunks\n",
      "46.wav - file_size:121275 - splitted into 1 chunks\n",
      "460.wav - file_size:198450 - splitted into 1 chunks\n",
      "461.wav - file_size:2844450 - splitted into 13 chunks\n",
      "462.wav - file_size:121275 - splitted into 1 chunks\n",
      "463.wav - file_size:242550 - splitted into 2 chunks\n",
      "464.wav - file_size:110250 - splitted into 1 chunks\n",
      "465.wav - file_size:1350437 - splitted into 7 chunks\n",
      "466.wav - file_size:154350 - splitted into 1 chunks\n",
      "467.wav - file_size:66150 - splitted into 1 chunks\n",
      "468.wav - file_size:639450 - splitted into 3 chunks\n",
      "469.wav - file_size:88200 - splitted into 1 chunks\n",
      "47.wav - file_size:1999206 - splitted into 9 chunks\n",
      "470.wav - file_size:1028412 - splitted into 5 chunks\n",
      "471.wav - file_size:220500 - splitted into 1 chunks\n",
      "472.wav - file_size:198450 - splitted into 1 chunks\n",
      "473.wav - file_size:1112923 - splitted into 5 chunks\n",
      "474.wav - file_size:3639402 - splitted into 17 chunks\n",
      "475.wav - file_size:401148 - splitted into 2 chunks\n",
      "476.wav - file_size:2535750 - splitted into 12 chunks\n",
      "477.wav - file_size:246960 - splitted into 2 chunks\n",
      "478.wav - file_size:948150 - splitted into 5 chunks\n",
      "479.wav - file_size:551250 - splitted into 3 chunks\n",
      "48.wav - file_size:44100 - splitted into 1 chunks\n",
      "480.wav - file_size:242550 - splitted into 2 chunks\n",
      "481.wav - file_size:50715 - splitted into 1 chunks\n",
      "482.wav - file_size:154350 - splitted into 1 chunks\n",
      "483.wav - file_size:66150 - splitted into 1 chunks\n",
      "484.wav - file_size:1284967 - splitted into 6 chunks\n",
      "485.wav - file_size:1246240 - splitted into 6 chunks\n",
      "486.wav - file_size:66150 - splitted into 1 chunks\n",
      "487.wav - file_size:88200 - splitted into 1 chunks\n",
      "488.wav - file_size:66150 - splitted into 1 chunks\n",
      "489.wav - file_size:485100 - splitted into 3 chunks\n",
      "49.wav - file_size:176400 - splitted into 1 chunks\n",
      "490.wav - file_size:120348 - splitted into 1 chunks\n",
      "491.wav - file_size:308700 - splitted into 2 chunks\n",
      "492.wav - file_size:88200 - splitted into 1 chunks\n",
      "493.wav - file_size:187425 - splitted into 1 chunks\n",
      "494.wav - file_size:44800 - splitted into 1 chunks\n",
      "495.wav - file_size:165320 - splitted into 1 chunks\n",
      "496.wav - file_size:78848 - splitted into 1 chunks\n",
      "497.wav - file_size:110250 - splitted into 1 chunks\n",
      "498.wav - file_size:88200 - splitted into 1 chunks\n",
      "499.wav - file_size:1132560 - splitted into 6 chunks\n",
      "5.wav - file_size:136059 - splitted into 1 chunks\n",
      "50.wav - file_size:3370467 - splitted into 16 chunks\n",
      "500.wav - file_size:319477 - splitted into 2 chunks\n",
      "501.wav - file_size:220500 - splitted into 1 chunks\n",
      "502.wav - file_size:44100 - splitted into 1 chunks\n",
      "503.wav - file_size:418950 - splitted into 2 chunks\n",
      "504.wav - file_size:529200 - splitted into 3 chunks\n",
      "505.wav - file_size:1176161 - splitted into 6 chunks\n",
      "506.wav - file_size:200704 - splitted into 1 chunks\n",
      "507.wav - file_size:44100 - splitted into 1 chunks\n",
      "508.wav - file_size:551250 - splitted into 3 chunks\n",
      "509.wav - file_size:195328 - splitted into 1 chunks\n",
      "51.wav - file_size:5040486 - splitted into 23 chunks\n",
      "510.wav - file_size:269440 - splitted into 2 chunks\n",
      "511.wav - file_size:1168650 - splitted into 6 chunks\n",
      "512.wav - file_size:1465997 - splitted into 7 chunks\n",
      "513.wav - file_size:396900 - splitted into 2 chunks\n",
      "514.wav - file_size:176400 - splitted into 1 chunks\n",
      "515.wav - file_size:88200 - splitted into 1 chunks\n",
      "516.wav - file_size:352800 - splitted into 2 chunks\n",
      "517.wav - file_size:44100 - splitted into 1 chunks\n",
      "518.wav - file_size:513383 - splitted into 3 chunks\n",
      "519.wav - file_size:1146600 - splitted into 6 chunks\n",
      "52.wav - file_size:88200 - splitted into 1 chunks\n",
      "520.wav - file_size:154350 - splitted into 1 chunks\n",
      "521.wav - file_size:1092132 - splitted into 5 chunks\n",
      "522.wav - file_size:88200 - splitted into 1 chunks\n",
      "523.wav - file_size:4104540 - splitted into 19 chunks\n",
      "524.wav - file_size:154350 - splitted into 1 chunks\n",
      "525.wav - file_size:529200 - splitted into 3 chunks\n",
      "526.wav - file_size:53760 - splitted into 1 chunks\n",
      "527.wav - file_size:154350 - splitted into 1 chunks\n",
      "528.wav - file_size:1565550 - splitted into 8 chunks\n",
      "529.wav - file_size:1245178 - splitted into 6 chunks\n",
      "53.wav - file_size:727650 - splitted into 4 chunks\n",
      "530.wav - file_size:97218 - splitted into 1 chunks\n",
      "531.wav - file_size:1212527 - splitted into 6 chunks\n",
      "532.wav - file_size:176400 - splitted into 1 chunks\n",
      "533.wav - file_size:145152 - splitted into 1 chunks\n",
      "534.wav - file_size:242550 - splitted into 2 chunks\n",
      "535.wav - file_size:545280 - splitted into 3 chunks\n",
      "536.wav - file_size:507150 - splitted into 3 chunks\n",
      "537.wav - file_size:352125 - splitted into 2 chunks\n",
      "538.wav - file_size:166528 - splitted into 1 chunks\n",
      "539.wav - file_size:992250 - splitted into 5 chunks\n",
      "54.wav - file_size:961380 - splitted into 5 chunks\n",
      "540.wav - file_size:205468 - splitted into 1 chunks\n",
      "541.wav - file_size:322046 - splitted into 2 chunks\n",
      "542.wav - file_size:352800 - splitted into 2 chunks\n",
      "543.wav - file_size:110250 - splitted into 1 chunks\n",
      "544.wav - file_size:523908 - splitted into 3 chunks\n",
      "545.wav - file_size:485100 - splitted into 3 chunks\n",
      "546.wav - file_size:44100 - splitted into 1 chunks\n",
      "547.wav - file_size:163170 - splitted into 1 chunks\n",
      "548.wav - file_size:286650 - splitted into 2 chunks\n",
      "549.wav - file_size:286650 - splitted into 2 chunks\n",
      "55.wav - file_size:2205000 - splitted into 10 chunks\n",
      "550.wav - file_size:88200 - splitted into 1 chunks\n",
      "551.wav - file_size:68408 - splitted into 1 chunks\n",
      "552.wav - file_size:220500 - splitted into 1 chunks\n",
      "553.wav - file_size:970200 - splitted into 5 chunks\n",
      "554.wav - file_size:485100 - splitted into 3 chunks\n",
      "555.wav - file_size:242550 - splitted into 2 chunks\n",
      "56.wav - file_size:66150 - splitted into 1 chunks\n",
      "57.wav - file_size:220500 - splitted into 1 chunks\n",
      "58.wav - file_size:4431438 - splitted into 20 chunks\n",
      "59.wav - file_size:132300 - splitted into 1 chunks\n",
      "6.wav - file_size:1818012 - splitted into 9 chunks\n",
      "60.wav - file_size:44100 - splitted into 1 chunks\n",
      "61.wav - file_size:264600 - splitted into 2 chunks\n",
      "62.wav - file_size:594194 - splitted into 3 chunks\n",
      "63.wav - file_size:176400 - splitted into 1 chunks\n",
      "64.wav - file_size:485100 - splitted into 3 chunks\n",
      "65.wav - file_size:121275 - splitted into 1 chunks\n",
      "66.wav - file_size:253879 - splitted into 2 chunks\n",
      "67.wav - file_size:262884 - splitted into 2 chunks\n",
      "68.wav - file_size:548262 - splitted into 3 chunks\n",
      "69.wav - file_size:88200 - splitted into 1 chunks\n",
      "7.wav - file_size:749700 - splitted into 4 chunks\n",
      "70.wav - file_size:32256 - splitted into 1 chunks\n",
      "71.wav - file_size:44100 - splitted into 1 chunks\n",
      "72.wav - file_size:308700 - splitted into 2 chunks\n",
      "73.wav - file_size:559104 - splitted into 3 chunks\n",
      "74.wav - file_size:176400 - splitted into 1 chunks\n",
      "75.wav - file_size:543840 - splitted into 3 chunks\n",
      "76.wav - file_size:573300 - splitted into 3 chunks\n",
      "77.wav - file_size:2050650 - splitted into 10 chunks\n",
      "78.wav - file_size:176400 - splitted into 1 chunks\n",
      "79.wav - file_size:5447817 - splitted into 25 chunks\n",
      "8.wav - file_size:264600 - splitted into 2 chunks\n",
      "80.wav - file_size:3087000 - splitted into 14 chunks\n",
      "81.wav - file_size:132300 - splitted into 1 chunks\n",
      "82.wav - file_size:264600 - splitted into 2 chunks\n",
      "83.wav - file_size:88200 - splitted into 1 chunks\n",
      "84.wav - file_size:291300 - splitted into 2 chunks\n",
      "85.wav - file_size:529200 - splitted into 3 chunks\n",
      "86.wav - file_size:330750 - splitted into 2 chunks\n",
      "87.wav - file_size:154350 - splitted into 1 chunks\n",
      "88.wav - file_size:198450 - splitted into 1 chunks\n",
      "89.wav - file_size:895640 - splitted into 4 chunks\n",
      "9.wav - file_size:1565550 - splitted into 8 chunks\n",
      "90.wav - file_size:132300 - splitted into 1 chunks\n",
      "91.wav - file_size:44100 - splitted into 1 chunks\n",
      "92.wav - file_size:2535750 - splitted into 12 chunks\n",
      "93.wav - file_size:44100 - splitted into 1 chunks\n",
      "94.wav - file_size:63945 - splitted into 1 chunks\n",
      "95.wav - file_size:1768126 - splitted into 8 chunks\n",
      "96.wav - file_size:88200 - splitted into 1 chunks\n",
      "97.wav - file_size:374850 - splitted into 2 chunks\n",
      "98.wav - file_size:132300 - splitted into 1 chunks\n",
      "99.wav - file_size:1190700 - splitted into 6 chunks\n",
      "finished chunking, total number of chunks: 1718\n",
      "chunked_one_file_dataset: Dataset({\n",
      "    features: ['audio', 'file_name'],\n",
      "    num_rows: 1718\n",
      "})\n",
      "\n",
      "preprocessing by preprocess_audio_arrays ...\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "bd16b3bd9b9547d3a6c42d24e59e7b63",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Map:   0%|          | 0/1718 [00:00<?, ? examples/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "calculating predictions by make_chunked_predictions ...\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "8fcd26bb2054421ea94b9dfc979eff05",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Map:   0%|          | 0/1718 [00:00<?, ? examples/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "predictions:      file_name predicted_class_id   \n",
      "0        0.wav                 14  \\\n",
      "1        1.wav                 60   \n",
      "2       10.wav                 26   \n",
      "3      100.wav                 56   \n",
      "4      100.wav                 43   \n",
      "...        ...                ...   \n",
      "1713    99.wav                 39   \n",
      "1714    99.wav                 39   \n",
      "1715    99.wav                 39   \n",
      "1716    99.wav                 39   \n",
      "1717    99.wav                 39   \n",
      "\n",
      "                                                 logits  \n",
      "0     [0.21219653, -0.26217923, 0.32218695, -1.37243...  \n",
      "1     [-0.015640395, -0.18922926, -1.214335, -0.1882...  \n",
      "2     [-1.1128302, 0.5142999, 0.12297872, -0.2029533...  \n",
      "3     [-0.16695037, -0.45232946, -0.9563749, -0.9499...  \n",
      "4     [-0.50878793, -0.062972456, 0.64381784, -0.885...  \n",
      "...                                                 ...  \n",
      "1713  [-0.08651759, -1.1758614, 0.3736053, -1.092433...  \n",
      "1714  [-0.13009883, -1.32632, 0.40541816, -1.1230453...  \n",
      "1715  [-0.2042117, -1.3307827, 0.42634982, -1.193528...  \n",
      "1716  [-0.3287763, -1.2629002, 0.32090884, -1.323447...  \n",
      "1717  [-0.8354643, -1.3131571, -0.39736977, -1.02635...  \n",
      "\n",
      "[1718 rows x 3 columns] \n",
      "\n",
      "\n",
      "RESULTS SAVED in:\n",
      "/root/data/experiments/models/sm-training-custom-2023-06-21-12-27-40-579/checkpoint-3504/predictions_test_10_secs_22050.csv\n",
      "/root/data/experiments/exp_2023-07-13_chunk_fixed_predictions/predictions_sm-sm-training-custom-2023-06-21-12-27-40-579_checkpoint-3504_test_10_secs_22050.csv\n"
     ]
    }
   ],
   "source": [
    "import copy\n",
    "from datasets import Dataset\n",
    "\n",
    "chunks = []\n",
    "total = 0\n",
    "for i, x in enumerate(test_dataset):\n",
    "    \n",
    "    one_file_dataset = test_dataset.select([i])\n",
    "    \n",
    "    #print(x)\n",
    "    file_size = len(x['audio']['array'])\n",
    "    #print('file_size:', file_size)\n",
    "    sampling_rate = x['audio']['sampling_rate']\n",
    "    #print('sampling_rate:', sampling_rate)\n",
    "    \n",
    "    chunk_size = SPLIT_IN_SECS * sampling_rate\n",
    "    n = int(file_size / chunk_size)\n",
    "    num = 0\n",
    "    for i_n in range(n+1):\n",
    "        if i_n > 0 and len(x['audio']['array'][i_n * chunk_size : (i_n + 1) * chunk_size]) < CHUNK_MIN_SIZE * sampling_rate:\n",
    "            break\n",
    "            \n",
    "        #print('chunk:', i_n)\n",
    "        x_chunk = copy.deepcopy(x)\n",
    "        x_chunk['audio']['array'] = x_chunk['audio']['array'][i_n * chunk_size : (i_n + 1) * chunk_size]\n",
    "        #print(x_chunk['audio']['array'])\n",
    "        \n",
    "        one_file_dataset.add_item(x_chunk)\n",
    "        chunks.append(x_chunk)\n",
    "        num += 1\n",
    "        total += 1\n",
    "    \n",
    "    print(f'{x[\"file_name\"]} - file_size:{file_size} - splitted into {num} chunks')\n",
    "    \n",
    "    #if i > 10:\n",
    "    #    break\n",
    "            \n",
    "print(f'finished chunking, total number of chunks: {total}')\n",
    "chunked_one_file_dataset = Dataset.from_pandas(pd.DataFrame(chunks))\n",
    "print('chunked_one_file_dataset:', chunked_one_file_dataset)\n",
    "    \n",
    "\n",
    "print('\\npreprocessing by preprocess_audio_arrays ...')\n",
    "chunked_one_file_dataset_encoded = chunked_one_file_dataset.map(lambda x: preprocess_audio_arrays(x, 'audio', 'array', feature_extractor), remove_columns=\"audio\", batched=True, batch_size = 16)\n",
    "chunked_one_file_dataset_encoded.set_format(type='torch', columns=['input_values'])\n",
    "    \n",
    "device = torch.device(\"cuda:0\" if torch.cuda.is_available() else \"cpu\")\n",
    "\n",
    "\n",
    "print('\\ncalculating predictions by make_chunked_predictions ...')\n",
    "chunked_one_file_dataset_encoded = chunked_one_file_dataset_encoded.map(lambda x: make_chunked_predictions(x['input_values'], model, device), batched=True, batch_size=16, remove_columns=\"input_values\")\n",
    "    \n",
    "chunked_one_file_dataset_encoded_df = chunked_one_file_dataset_encoded.to_pandas()\n",
    "print('\\npredictions:', chunked_one_file_dataset_encoded_df, '\\n\\n')\n",
    "chunked_one_file_dataset_encoded_df.to_csv(f\"/root/data/experiments/models/{model_name}/{checkpoint}/predictions_{FOLDER_TO_PROCESS}_{SPLIT_IN_SECS}_secs_{SAMPLING_RATE}.csv\", index=False)\n",
    "chunked_one_file_dataset_encoded_df.to_csv(f\"/root/data/experiments/exp_2023-07-13_chunk_fixed_predictions/predictions_{model_name}_{checkpoint}_{FOLDER_TO_PROCESS}_{SPLIT_IN_SECS}_secs_{SAMPLING_RATE}.csv\", index=False)\n",
    "print('RESULTS SAVED in:')\n",
    "print(f\"/root/data/experiments/models/{model_name}/{checkpoint}/predictions_{FOLDER_TO_PROCESS}_{SPLIT_IN_SECS}_secs_{SAMPLING_RATE}.csv\")\n",
    "print(f\"/root/data/experiments/exp_2023-07-13_chunk_fixed_predictions/predictions_{model_name}_{checkpoint}_{FOLDER_TO_PROCESS}_{SPLIT_IN_SECS}_secs_{SAMPLING_RATE}.csv\")\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c03b5e06-0d53-4eb4-8b5c-204091d1f74c",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "00c7d838-d709-4cf8-af24-7c333da7af65",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "901c0fa5-f8ab-4b11-af41-dbc2c54f84de",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "132de935-ad9c-4416-b685-1c6cc71ea931",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "availableInstances": [
   {
    "_defaultOrder": 0,
    "_isFastLaunch": true,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 4,
    "name": "ml.t3.medium",
    "vcpuNum": 2
   },
   {
    "_defaultOrder": 1,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 8,
    "name": "ml.t3.large",
    "vcpuNum": 2
   },
   {
    "_defaultOrder": 2,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 16,
    "name": "ml.t3.xlarge",
    "vcpuNum": 4
   },
   {
    "_defaultOrder": 3,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 32,
    "name": "ml.t3.2xlarge",
    "vcpuNum": 8
   },
   {
    "_defaultOrder": 4,
    "_isFastLaunch": true,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 8,
    "name": "ml.m5.large",
    "vcpuNum": 2
   },
   {
    "_defaultOrder": 5,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 16,
    "name": "ml.m5.xlarge",
    "vcpuNum": 4
   },
   {
    "_defaultOrder": 6,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 32,
    "name": "ml.m5.2xlarge",
    "vcpuNum": 8
   },
   {
    "_defaultOrder": 7,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 64,
    "name": "ml.m5.4xlarge",
    "vcpuNum": 16
   },
   {
    "_defaultOrder": 8,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 128,
    "name": "ml.m5.8xlarge",
    "vcpuNum": 32
   },
   {
    "_defaultOrder": 9,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 192,
    "name": "ml.m5.12xlarge",
    "vcpuNum": 48
   },
   {
    "_defaultOrder": 10,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 256,
    "name": "ml.m5.16xlarge",
    "vcpuNum": 64
   },
   {
    "_defaultOrder": 11,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 384,
    "name": "ml.m5.24xlarge",
    "vcpuNum": 96
   },
   {
    "_defaultOrder": 12,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 8,
    "name": "ml.m5d.large",
    "vcpuNum": 2
   },
   {
    "_defaultOrder": 13,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 16,
    "name": "ml.m5d.xlarge",
    "vcpuNum": 4
   },
   {
    "_defaultOrder": 14,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 32,
    "name": "ml.m5d.2xlarge",
    "vcpuNum": 8
   },
   {
    "_defaultOrder": 15,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 64,
    "name": "ml.m5d.4xlarge",
    "vcpuNum": 16
   },
   {
    "_defaultOrder": 16,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 128,
    "name": "ml.m5d.8xlarge",
    "vcpuNum": 32
   },
   {
    "_defaultOrder": 17,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 192,
    "name": "ml.m5d.12xlarge",
    "vcpuNum": 48
   },
   {
    "_defaultOrder": 18,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 256,
    "name": "ml.m5d.16xlarge",
    "vcpuNum": 64
   },
   {
    "_defaultOrder": 19,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 384,
    "name": "ml.m5d.24xlarge",
    "vcpuNum": 96
   },
   {
    "_defaultOrder": 20,
    "_isFastLaunch": false,
    "category": "General purpose",
    "gpuNum": 0,
    "hideHardwareSpecs": true,
    "memoryGiB": 0,
    "name": "ml.geospatial.interactive",
    "supportedImageNames": [
     "sagemaker-geospatial-v1-0"
    ],
    "vcpuNum": 0
   },
   {
    "_defaultOrder": 21,
    "_isFastLaunch": true,
    "category": "Compute optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 4,
    "name": "ml.c5.large",
    "vcpuNum": 2
   },
   {
    "_defaultOrder": 22,
    "_isFastLaunch": false,
    "category": "Compute optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 8,
    "name": "ml.c5.xlarge",
    "vcpuNum": 4
   },
   {
    "_defaultOrder": 23,
    "_isFastLaunch": false,
    "category": "Compute optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 16,
    "name": "ml.c5.2xlarge",
    "vcpuNum": 8
   },
   {
    "_defaultOrder": 24,
    "_isFastLaunch": false,
    "category": "Compute optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 32,
    "name": "ml.c5.4xlarge",
    "vcpuNum": 16
   },
   {
    "_defaultOrder": 25,
    "_isFastLaunch": false,
    "category": "Compute optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 72,
    "name": "ml.c5.9xlarge",
    "vcpuNum": 36
   },
   {
    "_defaultOrder": 26,
    "_isFastLaunch": false,
    "category": "Compute optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 96,
    "name": "ml.c5.12xlarge",
    "vcpuNum": 48
   },
   {
    "_defaultOrder": 27,
    "_isFastLaunch": false,
    "category": "Compute optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 144,
    "name": "ml.c5.18xlarge",
    "vcpuNum": 72
   },
   {
    "_defaultOrder": 28,
    "_isFastLaunch": false,
    "category": "Compute optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 192,
    "name": "ml.c5.24xlarge",
    "vcpuNum": 96
   },
   {
    "_defaultOrder": 29,
    "_isFastLaunch": true,
    "category": "Accelerated computing",
    "gpuNum": 1,
    "hideHardwareSpecs": false,
    "memoryGiB": 16,
    "name": "ml.g4dn.xlarge",
    "vcpuNum": 4
   },
   {
    "_defaultOrder": 30,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 1,
    "hideHardwareSpecs": false,
    "memoryGiB": 32,
    "name": "ml.g4dn.2xlarge",
    "vcpuNum": 8
   },
   {
    "_defaultOrder": 31,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 1,
    "hideHardwareSpecs": false,
    "memoryGiB": 64,
    "name": "ml.g4dn.4xlarge",
    "vcpuNum": 16
   },
   {
    "_defaultOrder": 32,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 1,
    "hideHardwareSpecs": false,
    "memoryGiB": 128,
    "name": "ml.g4dn.8xlarge",
    "vcpuNum": 32
   },
   {
    "_defaultOrder": 33,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 4,
    "hideHardwareSpecs": false,
    "memoryGiB": 192,
    "name": "ml.g4dn.12xlarge",
    "vcpuNum": 48
   },
   {
    "_defaultOrder": 34,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 1,
    "hideHardwareSpecs": false,
    "memoryGiB": 256,
    "name": "ml.g4dn.16xlarge",
    "vcpuNum": 64
   },
   {
    "_defaultOrder": 35,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 1,
    "hideHardwareSpecs": false,
    "memoryGiB": 61,
    "name": "ml.p3.2xlarge",
    "vcpuNum": 8
   },
   {
    "_defaultOrder": 36,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 4,
    "hideHardwareSpecs": false,
    "memoryGiB": 244,
    "name": "ml.p3.8xlarge",
    "vcpuNum": 32
   },
   {
    "_defaultOrder": 37,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 8,
    "hideHardwareSpecs": false,
    "memoryGiB": 488,
    "name": "ml.p3.16xlarge",
    "vcpuNum": 64
   },
   {
    "_defaultOrder": 38,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 8,
    "hideHardwareSpecs": false,
    "memoryGiB": 768,
    "name": "ml.p3dn.24xlarge",
    "vcpuNum": 96
   },
   {
    "_defaultOrder": 39,
    "_isFastLaunch": false,
    "category": "Memory Optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 16,
    "name": "ml.r5.large",
    "vcpuNum": 2
   },
   {
    "_defaultOrder": 40,
    "_isFastLaunch": false,
    "category": "Memory Optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 32,
    "name": "ml.r5.xlarge",
    "vcpuNum": 4
   },
   {
    "_defaultOrder": 41,
    "_isFastLaunch": false,
    "category": "Memory Optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 64,
    "name": "ml.r5.2xlarge",
    "vcpuNum": 8
   },
   {
    "_defaultOrder": 42,
    "_isFastLaunch": false,
    "category": "Memory Optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 128,
    "name": "ml.r5.4xlarge",
    "vcpuNum": 16
   },
   {
    "_defaultOrder": 43,
    "_isFastLaunch": false,
    "category": "Memory Optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 256,
    "name": "ml.r5.8xlarge",
    "vcpuNum": 32
   },
   {
    "_defaultOrder": 44,
    "_isFastLaunch": false,
    "category": "Memory Optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 384,
    "name": "ml.r5.12xlarge",
    "vcpuNum": 48
   },
   {
    "_defaultOrder": 45,
    "_isFastLaunch": false,
    "category": "Memory Optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 512,
    "name": "ml.r5.16xlarge",
    "vcpuNum": 64
   },
   {
    "_defaultOrder": 46,
    "_isFastLaunch": false,
    "category": "Memory Optimized",
    "gpuNum": 0,
    "hideHardwareSpecs": false,
    "memoryGiB": 768,
    "name": "ml.r5.24xlarge",
    "vcpuNum": 96
   },
   {
    "_defaultOrder": 47,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 1,
    "hideHardwareSpecs": false,
    "memoryGiB": 16,
    "name": "ml.g5.xlarge",
    "vcpuNum": 4
   },
   {
    "_defaultOrder": 48,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 1,
    "hideHardwareSpecs": false,
    "memoryGiB": 32,
    "name": "ml.g5.2xlarge",
    "vcpuNum": 8
   },
   {
    "_defaultOrder": 49,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 1,
    "hideHardwareSpecs": false,
    "memoryGiB": 64,
    "name": "ml.g5.4xlarge",
    "vcpuNum": 16
   },
   {
    "_defaultOrder": 50,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 1,
    "hideHardwareSpecs": false,
    "memoryGiB": 128,
    "name": "ml.g5.8xlarge",
    "vcpuNum": 32
   },
   {
    "_defaultOrder": 51,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 1,
    "hideHardwareSpecs": false,
    "memoryGiB": 256,
    "name": "ml.g5.16xlarge",
    "vcpuNum": 64
   },
   {
    "_defaultOrder": 52,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 4,
    "hideHardwareSpecs": false,
    "memoryGiB": 192,
    "name": "ml.g5.12xlarge",
    "vcpuNum": 48
   },
   {
    "_defaultOrder": 53,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 4,
    "hideHardwareSpecs": false,
    "memoryGiB": 384,
    "name": "ml.g5.24xlarge",
    "vcpuNum": 96
   },
   {
    "_defaultOrder": 54,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 8,
    "hideHardwareSpecs": false,
    "memoryGiB": 768,
    "name": "ml.g5.48xlarge",
    "vcpuNum": 192
   },
   {
    "_defaultOrder": 55,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 8,
    "hideHardwareSpecs": false,
    "memoryGiB": 1152,
    "name": "ml.p4d.24xlarge",
    "vcpuNum": 96
   },
   {
    "_defaultOrder": 56,
    "_isFastLaunch": false,
    "category": "Accelerated computing",
    "gpuNum": 8,
    "hideHardwareSpecs": false,
    "memoryGiB": 1152,
    "name": "ml.p4de.24xlarge",
    "vcpuNum": 96
   }
  ],
  "instance_type": "ml.t3.medium",
  "kernelspec": {
   "display_name": "GDSC (custom-gdsc/1)",
   "language": "python",
   "name": "python3__SAGEMAKER_INTERNAL__arn:aws:sagemaker:us-east-1:292159885427:image-version/custom-gdsc/1"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.8"
  },
  "lcc_arn": "arn:aws:sagemaker:us-east-1:292159885427:studio-lifecycle-config/clean-trash"
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
